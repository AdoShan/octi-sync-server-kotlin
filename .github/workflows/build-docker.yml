name: Build and Push Docker Image

on:
  push:
    branches:
      - main # 当推送到 'main' 分支时触发此工作流

jobs:
  build-docker-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read # 允许读取仓库内容
      packages: write # 允许写入 GitHub Packages (如果使用 ghcr.io)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup project and build environment
        # 使用项目内的 common-setup action，它会设置 JDK 和 Gradle 权限
        uses: ./.github/actions/common-setup

      - name: Package application
        run: ./gradlew installDist # 构建应用程序的可分发版本

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub (or other registry)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }} # 您的 Docker Hub 用户名
          password: ${{ secrets.DOCKER_PASSWORD }} # 您的 Docker Hub 访问令牌或密码
          # 如果您打算推送到 GitHub Packages (ghcr.io)，请使用以下配置：
          # registry: ghcr.io
          # username: ${{ github.actor }}
          # password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # Dockerfile 所在的路径，'.' 表示仓库根目录
          push: true
          tags: your_docker_username/octi-sync-server:latest # 替换为您的 Docker 镜像名称和标签
